// Add this new function to handle select changes
function handlePositionSelect(event) {
    const selectedValue = event.target.value;
    updateAvailableCrew(selectedValue);
}

// Add this new function to update available crew
function updateAvailableCrew() {
    // Get all crew selects
    const selects = document.querySelectorAll('.crew-select');
    
    // Get all currently assigned crew IDs
    const assignedCrewIds = Array.from(selects)
        .map(select => select.value)
        .filter(value => value !== "");

    // Update each select's options
    selects.forEach(select => {
        const currentValue = select.value;
        const originalOptions = window.allCrewMembers || [];
        
        // Clear and add the empty option
        select.innerHTML = '<option value="">Select Crew</option>';
        
        // Add only unassigned crew members plus the currently selected crew member for this position
        originalOptions.forEach(crew => {
            if (crew.grade !== 'CSA' && (!assignedCrewIds.includes(crew.id) || crew.id === currentValue)) {
                select.innerHTML += `<option value="${crew.id}" ${crew.id === currentValue ? 'selected' : ''}>
                    ${crew.grade} ${crew.name} (${crew.id})
                </option>`;
            }
        });
    });
}

// Modify the createPositionSelect function to add the onchange event
function createPositionSelect(position) {
    return `
        <div class="position-group">
            <label>${position}:</label>
            <select id="pos${position}" class="crew-select" onchange="handlePositionSelect(event)">
                <option value="">Select Crew</option>
            </select>
        </div>
    `;
}

// Modify the parseCrew function to store all crew members globally
function parseCrew() {
    const crewData = document.getElementById('crewList').value;
    const crewMembers = [];
    
    const lines = crewData.split('\n');
    for (let i = 0; i < lines.length - 2; i++) {
        const gradeLine = lines[i].trim();
        const nameLine = lines[i + 1].trim();
        const staffNumLine = lines[i + 2].trim();
        
        if (
            (gradeLine === 'PUR' || gradeLine === 'FG1' || gradeLine === 'GR1' || 
             gradeLine === 'GR2' || gradeLine === 'CSA') &&
            nameLine.length > 0 &&
            staffNumLine.startsWith('S')
        ) {
            crewMembers.push({
                grade: gradeLine,
                name: nameLine,
                id: staffNumLine
            });
            i += 2;
        }
    }

    // Store the crew members globally
    window.allCrewMembers = crewMembers;

    // Initial population of selects
    const selects = document.querySelectorAll('.crew-select');
    selects.forEach(select => {
        select.innerHTML = '<option value="">Select Crew</option>';
        crewMembers.forEach(crew => {
            if (crew.grade !== 'CSA') {
                select.innerHTML += `<option value="${crew.id}">${crew.grade} ${crew.name} (${crew.id})</option>`;
            }
        });
    });

    const parsedCrewDiv = document.getElementById('parsedCrew');
    parsedCrewDiv.style.display = 'block';
    parsedCrewDiv.innerHTML = '<h4>Parsed Crew Members:</h4>' + 
        crewMembers.map(crew => `${crew.grade} ${crew.name} (${crew.id})`).join('<br>');

    window.csaMember = crewMembers.find(crew => crew.grade === 'CSA');
}
